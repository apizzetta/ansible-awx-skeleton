---
- name: Configure en_US.UTF-8 locale
  locale_gen:
    name: en_US.UTF-8
    state: present

- name: Create SUDO user for the customer
  user:
    name: "{{ username }}"
    comment: "Default sudo user created by hopla.cloud"
    groups: sudo,admin
    shell: /bin/bash
    state: present

- name: Set authorized key for user copying it from current user
  authorized_key:
    user: "{{ username }}"
    state: present
    key: "{{ lookup('file', lookup('env','HOME') + '/.ssh/authorized_keys') }}"

- name: Check if the sudo rule exists
  stat:
    path: /etc/sudoers.d/90-Hoplacloud-sudo-users
  register: stat_sudo

- name: Update sudo rules
  template:
    src: 90-Hoplacloud-sudo-users.j2
    dest: /etc/sudoers.d/90-Hoplacloud-sudo-users
    owner: root
    group: root
    mode: '0600'
  when: stat_sudo.exists == False
